<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…«å­—æµ‹è¯„ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #ff6b6b, #ffa726);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            padding: 40px;
        }

        .input-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        .batch-input {
            width: 100%;
            min-height: 100px;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 14px;
            margin-bottom: 20px;
            font-family: inherit;
            resize: vertical;
        }

        .batch-input::placeholder {
            color: #adb5bd;
        }

        .input-mode-switch {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            padding: 10px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .mode-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            background: #e9ecef;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mode-btn.active {
            background: #667eea;
            color: white;
        }

        .result-section {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        .result-grid {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 20px;
        }

        .result-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            border-left: 4px solid #667eea;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .result-card.error {
            border-left-color: #f44336;
            background: #fff8f8;
        }

        .result-card.info {
            border-left-color: #2196F3;
            background: #f8fbff;
        }

        .format-example {
            padding: 8px 12px;
            background: #f5f5f5;
            border-radius: 6px;
            margin: 4px 0;
            font-family: monospace;
        }

        .input-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            font-size: 14px;
        }

        input, select {
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .calculate-btn {
            background: linear-gradient(135deg, #667eea);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .calculate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .bazi-table {
            width: auto;
            margin: 20px 0;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        .pillar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 10px;
            margin-bottom: 10px;
            color: #666;
            font-size: 14px;
        }

        .pillar-header span {
            flex: 1;
            text-align: center;
        }

        .pillar-container {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 8px;
            padding: 0 10px;
        }

        .pillar-group {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .pillar-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }

        .bazi-table th {
            background-color: #667eea;
            color: white;
            padding: 12px 20px;
            text-align: center;
        }

        .bazi-table td {
            padding: 12px 20px;
            text-align: center;
            border-bottom: 1px solid #eee;
            white-space: nowrap;
        }

        .element {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 5px;
        }

        .wood { background: #4caf50; color: white; }
        .fire { background: #f44336; color: white; }
        .earth { background: #ff9800; color: white; }
        .metal { background: #9e9e9e; color: white; }
        .water { background: #2196f3; color: white; }

        .analysis-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border-left: 3px solid #ff6b6b;
        }

        .analysis-item.positive {
            border-left-color: #4caf50;
            background: #e8f5e8;
        }

        .adjustment-section {
            background: linear-gradient(135deg, #ff6b6b, #ffa726);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
        }

        .adjustment-section h4 {
            margin-bottom: 10px;
        }

        .zodiac-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 8px;
        }

        .zodiac-emoji {
            font-size: 24px;
        }

        @media (max-width: 768px) {
            .input-group {
                grid-template-columns: 1fr;
            }
            .header h1 {
                font-size: 2em;
            }
            .main-content {
                padding: 20px;
            }
        }

        /* å‚è€ƒå›¾è¡¨æ ·å¼ */
        .lookup-container {
            display: none;
            background: #f8f9fa;
            padding: 5px;
            border-radius: 15px;
            margin-top: 5px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        .lookup-container h3 {
            text-align: center;
            margin-bottom: 10px;
            color: #333;
        }
        .lookup-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 10px;
            font-size: 14px;
        }
        .lookup-table th, .lookup-table td {
            border: 1px solid #ddd;
            padding: 8px 10px;
            text-align: center;
        }
        .lookup-table th {
            font-weight: 600;
        }
        .shichen-table td strong {
            display: block;
        }
        .xiongshu-header {
            color: white;
            font-weight: bold;
        }
        .bajue-header { background-color: #b3f803; } /* yellowgreen */
        .liuchong-header { background-color: #00b6f3; } /* lightblue */
        .shuangmu-header { background-color: #e9d900; } /* khaki */
        .zhongliu-header { background-color: #fc580c; } /* turquoise */

        .xiongshu-tables-container {
            display: flex;
            gap: 15px;
            align-items: flex-start;
        }
        .xiongshu-tables-container > div {
            flex: 1;
        }

        /* æ·»åŠ é«˜äº®æ ·å¼ */
        .highlight-combination {
            display: inline-block;
            padding: 2px 4px;
            border: 1px solid red;
            border-radius: 3px;
            line-height: 1;
        }

        .horizontal-line {
            width: 30px;
            height: 2px;
            background: #333;
            display: inline-block;
        }

        .element-tag {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            color: white;
            font-size: 14px;
            margin-left: 2px;
        }
    </style>
</head>
<body>
    <div id="protected-content" style="visibility: hidden;">
        <div class="container">
            <div class="header">
                <h1>ğŸŒŸ å…«å­—æµ‹è¯„ç³»ç»Ÿ ğŸŒŸ</h1>
                <p>ä¼ ç»Ÿå‘½ç†å­¦ä¸ç°ä»£æŠ€æœ¯çš„å®Œç¾ç»“åˆ</p>
            </div>

            <div class="main-content">
                <div class="input-section">
                    <div class="input-mode-switch">
                        <button class="mode-btn active" onclick="switchMode('single')" id="singleModeBtn">å•ä¸ªå…«å­— (ç¦ç”¨) </button>
                        <button class="mode-btn " onclick="switchMode('batch')" id="batchModeBtn">æ‰¹é‡å…«å­—ï¼ˆæ¨èï¼‰</button>
                    </div>
                    
                    <div id="singleInputMode" >
                        <h2 style="margin-bottom: 25px; color: #333;">ğŸ“… è¯·è¾“å…¥æ‚¨çš„å‡ºç”Ÿä¿¡æ¯</h2>
                    <div class="input-group">
                        <div class="form-group">
                            <label for="year">å‡ºç”Ÿå¹´ä»½</label>
                            <input type="number" id="year" placeholder="ä¾‹å¦‚ï¼š1999" min="1900" max="2030">
                        </div>
                        <div class="form-group">
                            <label for="month">å‡ºç”Ÿæœˆä»½</label>
                            <select id="month">
                                <option value="">è¯·é€‰æ‹©æœˆä»½</option>
                                <option value="1">æ­£æœˆ</option>
                                <option value="2">äºŒæœˆ</option>
                                <option value="3">ä¸‰æœˆ</option>
                                <option value="4">å››æœˆ</option>
                                <option value="5">äº”æœˆ</option>
                                <option value="6">å…­æœˆ</option>
                                <option value="7">ä¸ƒæœˆ</option>
                                <option value="8">å…«æœˆ</option>
                                <option value="9">ä¹æœˆ</option>
                                <option value="10">åæœˆ</option>
                                <option value="11">å†¬æœˆ</option>
                                <option value="12">è…Šæœˆ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="day">å‡ºç”Ÿæ—¥æœŸ</label>
                            <input type="number" id="day" placeholder="ä¾‹å¦‚ï¼š15" min="1" max="31">
                        </div>
                        <div class="form-group">
                            <label for="hour">å‡ºç”Ÿæ—¶é—´</label>
                            <select id="hour">
                                <option value="">è¯·é€‰æ‹©æ—¶è¾°</option>
                                <option value="1">å­æ—¶ (23:00-01:00)</option>
                                <option value="2">ä¸‘æ—¶ (01:00-03:00)</option>
                                <option value="3">å¯…æ—¶ (03:00-05:00)</option>
                                <option value="4">å¯æ—¶ (05:00-07:00)</option>
                                <option value="5">è¾°æ—¶ (07:00-09:00)</option>
                                <option value="6">å·³æ—¶ (09:00-11:00)</option>
                                <option value="7">åˆæ—¶ (11:00-13:00)</option>
                                <option value="8">æœªæ—¶ (13:00-15:00)</option>
                                <option value="9">ç”³æ—¶ (15:00-17:00)</option>
                                <option value="10">é…‰æ—¶ (17:00-19:00)</option>
                                <option value="11">æˆŒæ—¶ (19:00-21:00)</option>
                                <option value="12">äº¥æ—¶ (21:00-23:00)</option>
                            </select>
                            </div>
                        </div>
                    </div>

                    <div id="batchInputMode" style="display: none;">
                        <h2 style="margin-bottom: 25px; color: #333;">ğŸ“‘ æ‰¹é‡å…«å­—æ’ç›˜</h2>
                        <textarea class="batch-input" id="batchInput" placeholder="è¯·è¾“å…¥å¾…æ’ç›˜çš„æ—¥æœŸæ—¶é—´ï¼Œæ¯è¡Œä¸€ä¸ªã€‚æ”¯æŒä»¥ä¸‹æ ¼å¼ï¼š
1999å¹´æ­£æœˆåˆäºŒæ—©ä¸Š9ç‚¹
2000å¹´3æœˆ15æ—¥ä¸‹åˆ2ç‚¹
1988å¹´è…ŠæœˆäºŒåä¸‰æ™šä¸Š11ç‚¹
2023å¹´å†¬æœˆåˆå…«ä¸Šåˆ10ç‚¹
1999.1.13è¾°æ—¶"></textarea>
                    </div>

                    <div style="text-align: center; margin-top: 25px;">
                        <button class="calculate-btn" onclick="calculateBazi()" id="singleCalcBtn">ğŸ”® å¼€å§‹æµ‹è¯„</button>
                        <button class="calculate-btn" onclick="calculateBatchBazi()" id="batchCalcBtn" style="display: none;">ğŸ”® æ‰¹é‡æµ‹è¯„</button>
                        <button class="calculate-btn" onclick="toggleLookupTables()" style="background: linear-gradient(135deg, #4caf50, #81c784); margin-left: 15px;">ğŸ“– æŸ¥çœ‹å‚è€ƒå›¾è¡¨</button>
                    </div>
                </div>

                <div class="result-section" id="resultSection">
                    <div class="result-grid" id="resultGrid">
                    <!-- ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </div>
                </div>

                 <div class="lookup-container" id="lookupTablesContainer">
                    <table class="lookup-table shichen-table">
                        <tbody>
                            <tr>
                                <td><strong>å­æ—¶-1</strong>23:00-1:00</td>
                                <td><strong>ä¸‘æ—¶-2</strong>1:00-3:00</td>
                                <td><strong>å¯…æ—¶-3</strong>3:00-5:00</td>
                                <td><strong>å¯æ—¶-4</strong>5:00-7:00</td>
                                <td><strong>è¾°æ—¶-5</strong>7:00-9:00</td>
                                <td><strong>å·³æ—¶-6</strong>9:00-11:00</td>
                            </tr>
                            <tr>
                                <td><strong>åˆæ—¶-7</strong>11:00-13:00</td>
                                <td><strong>æœªæ—¶-8</strong>13:00-15:00</td>
                                <td><strong>ç”³æ—¶-9</strong>15:00-17:00</td>
                                <td><strong>é…‰æ—¶-10</strong>17:00-19:00</td>
                                <td><strong>æˆŒæ—¶-11</strong>19:00-21:00</td>
                                <td><strong>äº¥æ—¶-12</strong>21:00-23:00</td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="xiongshu-tables-container">
                        <div>
                            <table class="lookup-table">
                                <thead><tr><th colspan="2" class="xiongshu-header bajue-header">å…«ç»æ•°ç»„</th></tr></thead>
                                <tbody>
                                    <tr><td>1-8</td><td>8-1</td></tr>
                                    <tr><td>1-9</td><td>9-1</td></tr>
                                    <tr><td>6-2</td><td>2-6</td></tr>
                                    <tr><td>3-5</td><td>5-3</td></tr>
                                    <tr><td>3-6</td><td>6-3</td></tr>
                                    <tr><td>4-10</td><td>10-4</td></tr>
                                    <tr><td>11-7</td><td>7-11</td></tr>
                                    <tr><td>7-12</td><td>12-7</td></tr>
                                </tbody>
                            </table>
                        </div>
                        <div>
                            <table class="lookup-table">
                                <thead><tr><th colspan="2" class="xiongshu-header liuchong-header">å…­å†²æ•°ç»„</th></tr></thead>
                                <tbody>
                                    <tr><td>1-7</td><td>7-1</td></tr>
                                    <tr><td>8-2</td><td>2-8</td></tr>
                                    <tr><td>3-9</td><td>9-3</td></tr>
                                    <tr><td>10-4</td><td>4-10</td></tr>
                                    <tr><td>11-5</td><td>5-11</td></tr>
                                    <tr><td>12-6</td><td>6-12</td></tr>
                                </tbody>
                            </table>
                        </div>
                        <div>
                            <table class="lookup-table">
                                 <thead><tr><th colspan="2" class="xiongshu-header shuangmu-header">åŒæœ¨å…‹åœŸ</th></tr></thead>
                                <tbody>
                                    <tr><td>3-8-4</td><td>3-8-5</td></tr>
                                    <tr><td>3-9-4</td><td>3-9-5</td></tr>
                                    <tr><td>4-3-4</td><td>4-3-5</td></tr>
                                    <tr><td>4-8-5</td><td>4-9-5</td></tr>
                                    <tr><td>4-8-4</td><td>4-9-4</td></tr>
                                    <tr><td>5-8-5</td><td>5-9-5</td></tr>
                                    <tr><td>5-3-5</td><td></td></tr>
                                </tbody>
                            </table>
                        </div>
                        <div>
                            <table class="lookup-table">
                                <thead><tr><th class="xiongshu-header zhongliu-header">è‚¿ç˜¤æ•°å­—</th></tr></thead>
                                <tbody>
                                    <tr><td>3-3</td></tr>
                                    <tr><td>3-9</td></tr>
                                    <tr><td>6-3</td></tr>
                                    <tr><td>7-3</td></tr>
                                    <tr><td>9-3</td></tr>
                                    <tr><td>9-9</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <footer>
                <p style="text-align: center;">å…è´£å£°æ˜ï¼šæœ¬å·¥å…·ä»…ä¾›å¨±ä¹å’Œå‚è€ƒï¼Œè¯·å‹¿ç”¨äºå†³ç­–ä¾æ®ã€‚åé¦ˆ-->ç‹æ˜­é˜³ï¼šwq483489278</p>
            </footer>
        </div>
    </div>

    <script>
        function calculateLowerNumber(upperNumber) {
            // å¦‚æœä¸Šå¦æ•°å­—å¤§äº6ï¼Œå‡å»6ï¼›å¦‚æœå°äºç­‰äº6ï¼ŒåŠ ä¸Š6
            return upperNumber > 6 ? upperNumber - 6 : upperNumber + 6;
        }

        function switchMode(mode) {
            const singleMode = document.getElementById('singleInputMode');
            const batchMode = document.getElementById('batchInputMode');
            const singleBtn = document.getElementById('singleModeBtn');
            const batchBtn = document.getElementById('batchModeBtn');
            const singleCalcBtn = document.getElementById('singleCalcBtn');
            const batchCalcBtn = document.getElementById('batchCalcBtn');

            if (mode === 'single') {
                singleMode.style.display = 'block';
                batchMode.style.display = 'none';
                singleBtn.classList.add('active');
                batchBtn.classList.remove('active');
                singleCalcBtn.style.display = 'inline-block';
                batchCalcBtn.style.display = 'none';
            } else {
                singleMode.style.display = 'none';
                batchMode.style.display = 'block';
                singleBtn.classList.remove('active');
                batchBtn.classList.add('active');
                singleCalcBtn.style.display = 'none';
                batchCalcBtn.style.display = 'inline-block';
            }
        }

        function toggleLookupTables() {
            const container = document.getElementById('lookupTablesContainer');
            if (container.style.display === 'none' || container.style.display === '') {
                container.style.display = 'block';
                container.scrollIntoView({ behavior: 'smooth' });
            } else {
                container.style.display = 'none';
            }
        }

        // æ•°å­—ç»„åˆå®šä¹‰
        // å…«ç»æ•°ç»„
        const baJue = [
            [1,8], [1,9], [6,2], [3,5], [3,6], [4,10], [11,7], [7,12],
            [8,1], [9,1], [2,6], [5,3], [6,3], [10,4], [7,11], [12,7]
        ];

        // å…­å†²æ•°ç»„
        const liuChong = [
            [1,7], [8,2], [3,9], [10,4], [11,5], [12,6],
            [7,1], [2,8], [9,3], [4,10], [5,11], [6,12]
        ];

        // åŒæœ¨å…‹åœŸ
        const shuangMuKeTu = [
            [3,8,4], [3,9,4], [4,3,4], [4,8,5], [4,8,4], [5,8,5],
            [3,8,5], [3,9,5], [4,3,5], [4,9,5], [4,9,4], [5,9,5], [5,3,5]
        ];

        // è‚¿ç˜¤æ•°å­—
        const zhongLiu = [[3,3], [3,9], [6,3], [7,3], [9,3], [9,9]];

        // ç”Ÿè‚–æ•°æ®
        const zodiacData = {
            1: { name: 'å­é¼ ', emoji: 'ğŸ­' },
            2: { name: 'ä¸‘ç‰›', emoji: 'ğŸ®' },
            3: { name: 'å¯…è™', emoji: 'ğŸ¯' },
            4: { name: 'å¯å…”', emoji: 'ğŸ°' },
            5: { name: 'è¾°é¾™', emoji: 'ğŸ²' },
            6: { name: 'å·³è›‡', emoji: 'ğŸ' },
            7: { name: 'åˆé©¬', emoji: 'ğŸ´' },
            8: { name: 'æœªç¾Š', emoji: 'ğŸ‘' },
            9: { name: 'ç”³çŒ´', emoji: 'ğŸµ' },
            10: { name: 'é…‰é¸¡', emoji: 'ğŸ”' },
            11: { name: 'æˆŒç‹—', emoji: 'ğŸ•' },
            12: { name: 'äº¥çŒª', emoji: 'ğŸ·' }
        };

        // ç®€åŒ–ä¸ºçº¯æ•°å­—äº”è¡Œå¯¹åº”å…³ç³»
        function getElementForNumber(num) {
            const numberElements = {
                1: 'æ°´',
                2: 'æ°´',
                3: 'åœŸ',
                4: 'æœ¨',
                5: 'æœ¨',
                6: 'ç«',
                7: 'ç«',
                8: 'åœŸ',
                9: 'åœŸ',
                10: 'é‡‘',
                11: 'é‡‘',
                12: 'æ°´'
            };
            return numberElements[num] || 'æœªçŸ¥';
        }

        // äº”è¡Œå¯¹åº”çš„é¢œè‰²
        function getElementClass(element) {
            const elementColors = {
                'æœ¨': '#4CAF50',  // ç»¿è‰²
                'ç«': '#F44336',  // çº¢è‰²
                'åœŸ': '#FF9800',  // æ©™è‰²
                'é‡‘': '#9E9E9E',  // ç°è‰²
                'æ°´': '#2196F3'   // è“è‰²
            };
            return elementColors[element] || '#000000';
        }

        function calculateBazi() {
            const year = parseInt(document.getElementById('year').value);
            const month = parseInt(document.getElementById('month').value);
            const day = parseInt(document.getElementById('day').value);
            const hour = parseInt(document.getElementById('hour').value);

            if (!year || !month || !day || !hour) {
                alert('è¯·å¡«å†™å®Œæ•´çš„å‡ºç”Ÿä¿¡æ¯ï¼');
                return;
            }

            // è®¡ç®—ç”Ÿè‚–æ’å
            const zodiacIndex = ((year - 4) % 12) + 1;
            const zodiacRank = zodiacIndex <= 0 ? zodiacIndex + 12 : zodiacIndex;

            // è®¡ç®—ä¸Šå¦
            const upperGua = {
                year: zodiacRank,  // ä½¿ç”¨ç”Ÿè‚–æ’å
                month: month,
                day: day <= 12 ? [day] : splitDayNumber(day),  // ä½¿ç”¨è¾…åŠ©å‡½æ•°æ‹†åˆ†æ—¥æœŸ
                hour: hour
            };

            // è®¡ç®—ä¸‹å¦ï¼ˆæŒ‰ç…§ä¸Šå¦æ•°å­—Â±6çš„è§„åˆ™ï¼‰
            const lowerGua = {
                year: calculateLowerNumber(upperGua.year),
                month: calculateLowerNumber(upperGua.month),
                day: upperGua.day.map(d => calculateLowerNumber(d)),
                hour: calculateLowerNumber(upperGua.hour)
            };

            // æ˜¾ç¤ºç»“æœ
            displayResults(year, zodiacRank, upperGua, lowerGua);
        }

        // å†œå†æœˆä»½æ˜ å°„
        const lunarMonths = {
            'æ­£': 1, 'äºŒ': 2, 'ä¸‰': 3, 'å››': 4, 'äº”': 5, 'å…­': 6,
            'ä¸ƒ': 7, 'å…«': 8, 'ä¹': 9, 'å': 10, 'å†¬': 11, 'è…Š': 12
        };

        // å†œå†æ—¥æœŸæ˜ å°„
        const lunarDays = {
            'åˆä¸€': 1, 'åˆäºŒ': 2, 'åˆä¸‰': 3, 'åˆå››': 4, 'åˆäº”': 5,
            'åˆå…­': 6, 'åˆä¸ƒ': 7, 'åˆå…«': 8, 'åˆä¹': 9, 'åˆå': 10,
            'åä¸€': 11, 'åäºŒ': 12, 'åä¸‰': 13, 'åå››': 14, 'åäº”': 15,
            'åå…­': 16, 'åä¸ƒ': 17, 'åå…«': 18, 'åä¹': 19, 'äºŒå': 20,
            'å»¿ä¸€': 21, 'å»¿ä¸€': 21, 'å»¿äºŒ': 22, 'äºŒåäºŒ': 22, 
            'å»¿ä¸‰': 23, 'äºŒåä¸‰': 23, 'å»¿å››': 24, 'äºŒåå››': 24,
            'å»¿äº”': 25, 'äºŒåäº”': 25, 'å»¿å…­': 26, 'äºŒåå…­': 26,
            'å»¿ä¸ƒ': 27, 'äºŒåä¸ƒ': 27, 'å»¿å…«': 28, 'äºŒåå…«': 28,
            'å»¿ä¹': 29, 'äºŒåä¹': 29, 'ä¸‰å': 30
        };

        // æ—¶è¾°æ˜ å°„
        const timeMap = {
            'å­æ—¶': 1, 'ä¸‘æ—¶': 2, 'å¯…æ—¶': 3, 'å¯æ—¶': 4, 'è¾°æ—¶': 5, 'å·³æ—¶': 6,
            'åˆæ—¶': 7, 'æœªæ—¶': 8, 'ç”³æ—¶': 9, 'é…‰æ—¶': 10, 'æˆŒæ—¶': 11, 'äº¥æ—¶': 12
        };

        function splitDayNumber(day) {
            if (day <= 12) return [day];
            
            // å¤„ç†æ—¥æœŸæ‹†åˆ†
            const result = [];
            
            if (day % 10 === 0) {
                // å¤„ç†æ•´åæ•°ï¼ˆ20ã€30ï¼‰
                result.push(Math.floor(day / 10)); // åä½æ•°
                result.push(10);                   // è¡¥å……10
            } else {
                // å¤„ç†å…¶ä»–æ•°å­—ï¼ˆ13-19, 21-29, 31ï¼‰
                result.push(Math.floor(day / 10)); // åä½æ•°
                result.push(10);                   // ä¸­é—´è¡¥å……10
                result.push(day % 10);            // ä¸ªä½æ•°
            }
            
            return result;
        }

        function parseDateString(dateStr) {
            try {
                let year, month, day, hour;
                
                // å¤„ç†ä¸åŒçš„æ—¥æœŸæ ¼å¼
                if (dateStr.includes('.')) {
                    // å¤„ç† 1999.1.13è¾°æ—¶ æ ¼å¼
                    const parts = dateStr.split('.');
                    if (parts.length !== 3) throw new Error('æ ¼å¼é”™è¯¯ï¼šåº”ä¸º"å¹´.æœˆ.æ—¥ æ—¶è¾°"æ ¼å¼');
                    
                    year = parseInt(parts[0]);
                    month = parseInt(parts[1]);
                    
                    // åˆ†å‰²æ—¥æœŸå’Œæ—¶è¾°
                    const dayAndTime = parts[2].trim().split(/\s+/);
                    if (dayAndTime.length !== 2) throw new Error('æ ¼å¼é”™è¯¯ï¼šæ—¥æœŸå’Œæ—¶è¾°ä¹‹é—´éœ€è¦ç©ºæ ¼åˆ†éš”');
                    
                    day = parseInt(dayAndTime[0]);
                    const timeStr = dayAndTime[1];
                    
                    // æ£€æŸ¥æ—¶è¾°æ ¼å¼
                    if (!timeStr.match(/[å­ä¸‘å¯…å¯è¾°å·³åˆæœªç”³é…‰æˆŒäº¥]æ—¶/)) {
                        throw new Error('æ—¶è¾°æ ¼å¼é”™è¯¯ï¼šåº”ä¸º"å­æ—¶/ä¸‘æ—¶/..."ç­‰æ ¼å¼');
                    }
                    
                    hour = timeMap[timeStr];
                } else if (dateStr.match(/\d{4}å¹´\d{1,2}æœˆ\d{1,2}æ—¥/)) {
                    // å¤„ç† 2000å¹´3æœˆ15æ—¥ä¸‹åˆ2ç‚¹ æ ¼å¼
                    const yearMatch = dateStr.match(/(\d{4})å¹´/);
                    const monthMatch = dateStr.match(/(\d{1,2})æœˆ/);
                    const dayMatch = dateStr.match(/(\d{1,2})æ—¥/);
                    
                    year = yearMatch ? parseInt(yearMatch[1]) : null;
                    month = monthMatch ? parseInt(monthMatch[1]) : null;
                    day = dayMatch ? parseInt(dayMatch[1]) : null;
                    
                    // æå–æ—¶é—´éƒ¨åˆ†
                    const timeStr = dateStr.substring(dateStr.indexOf('æ—¥') + 1).trim();
                    hour = convertTimeToHour(timeStr);
                } else {
                    // å¤„ç†å†œå†æ ¼å¼
                    const yearMatch = dateStr.match(/(\d{4})å¹´/);
                    year = yearMatch ? parseInt(yearMatch[1]) : null;

                    // åŒ¹é…æœˆä»½
                    const monthMatch = dateStr.match(/([æ­£äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åå†¬è…Š])æœˆ/);
                    month = monthMatch ? lunarMonths[monthMatch[1]] : null;

                    // åŒ¹é…æ—¥æœŸï¼ˆæ”¯æŒ"äºŒåä¸‰"å’Œ"å»¿ä¸‰"ä¸¤ç§å†™æ³•ï¼‰
                    let dayMatch = dateStr.match(/(åˆ[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]|å[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹]|äºŒå[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹]?|å»¿[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹]|ä¸‰å)/);
                    let dayNum = dayMatch ? lunarDays[dayMatch[1]] : null;

                    // åŒ¹é…æ—¶é—´
                    const timeStr = dateStr.substring(dateStr.indexOf('æœˆ') + 1).trim();
                    if (timeStr.includes('æ—¶')) {
                        const timeMatch = timeStr.match(/([å­ä¸‘å¯…å¯è¾°å·³åˆæœªç”³é…‰æˆŒäº¥])æ—¶/);
                        hour = timeMatch ? timeMap[timeMatch[0]] : null;
                    } else {
                        hour = convertTimeToHour(timeStr);
                    }

                    // è®¾ç½®æ—¥æœŸ
                    day = dayNum;
                }

                // éªŒè¯æ‰€æœ‰å¿…éœ€çš„å€¼éƒ½å·²è·å–
                if (!year || !month || !day || !hour) {
                    throw new Error('æ— æ³•è§£æå®Œæ•´çš„æ—¥æœŸæ—¶é—´ä¿¡æ¯');
                }

                // éªŒè¯å€¼çš„åˆç†æ€§
                if (year < 1900 || year > 2100) throw new Error('å¹´ä»½è¶…å‡ºèŒƒå›´(1900-2100)');
                if (month < 1 || month > 12) throw new Error('æœˆä»½è¶…å‡ºèŒƒå›´(1-12)');
                if (day < 1 || day > 31) throw new Error('æ—¥æœŸè¶…å‡ºèŒƒå›´(1-31)');
                if (hour < 1 || hour > 12) throw new Error('æ—¶è¾°è¶…å‡ºèŒƒå›´(1-12)');

                return { year, month, day, hour };
            } catch (error) {
                console.error(`è§£ææ—¥æœŸæ—¶å‡ºé”™: ${dateStr}`, error);
                return { error: error.message || 'æ ¼å¼é”™è¯¯' };
            }
        }

        function convertTimeToHour(timeStr) {
            if (!timeStr) return null;

            // å¦‚æœå·²ç»æ˜¯æ—¶è¾°æ ¼å¼ï¼Œç›´æ¥è¿”å›å¯¹åº”çš„æ•°å­—
            if (timeStr.match(/[å­ä¸‘å¯…å¯è¾°å·³åˆæœªç”³é…‰æˆŒäº¥]æ—¶/)) {
                return timeMap[timeStr];
            }

            // å¤„ç†æ—©ä¸Š/ä¸Šåˆ/ä¸‹åˆ/æ™šä¸Š + å…·ä½“æ—¶é—´
            const timeMatch = timeStr.match(/(æ—©ä¸Š|ä¸Šåˆ|ä¸‹åˆ|æ™šä¸Š)?.*?(\d{1,2})[ç‚¹æ—¶]/);
            if (!timeMatch) return null;

            let hour = parseInt(timeMatch[2]);
            const period = timeMatch[1];

            // æ ¹æ®æ—¶é—´æ®µè°ƒæ•´å°æ—¶æ•°
            if (period === 'ä¸‹åˆ' || period === 'æ™šä¸Š') {
                if (hour < 12) hour += 12;
            } else if ((period === 'æ—©ä¸Š' || period === 'ä¸Šåˆ') && hour === 12) {
                hour = 0;
            }

            // è½¬æ¢ä¸ºæ—¶è¾°ï¼ˆæ¯ä¸ªæ—¶è¾°ç®¡2ä¸ªå°æ—¶ï¼‰
            // å­æ—¶ï¼ˆ23:00-1:00ï¼‰å¼€å§‹ï¼ŒæŒ‰ç…§2å°æ—¶ä¸€ä¸ªæ—¶è¾°è®¡ç®—
            hour = (hour + 1) % 24;  // è°ƒæ•´åˆ°0-23èŒƒå›´
            return Math.floor(hour / 2) + 1;
        }

        function calculateBatchBazi() {
            const input = document.getElementById('batchInput').value;
            const dates = input.split('\n').filter(line => line.trim());
            
            const resultGrid = document.getElementById('resultGrid');
            resultGrid.innerHTML = ''; // æ¸…ç©ºç°æœ‰ç»“æœ

            let hasError = false;
            dates.forEach((dateStr, index) => {
                const parsedDate = parseDateString(dateStr.trim());
                
                // æ·»åŠ åˆ†éš”çº¿ï¼ˆé™¤äº†ç¬¬ä¸€ä¸ªç»“æœï¼‰
                if (index > 0) {
                    const divider = document.createElement('hr');
                    divider.style.margin = '20px 0';
                    divider.style.border = 'none';
                    divider.style.borderTop = '1px dashed #ddd';
                    resultGrid.appendChild(divider);
                }

                if (!parsedDate.error) {
                    const { year, month, day, hour } = parsedDate;
                    // è®¡ç®—å•ä¸ªå…«å­—
                    const zodiacIndex = ((year - 4) % 12) + 1;
                    const zodiacRank = zodiacIndex <= 0 ? zodiacIndex + 12 : zodiacIndex;

                    // å¤„ç†æ—¥æŸ±æ‹†åˆ†
                    const dayNumbers = splitDayNumber(day);

                    const upperGua = {
                        year: zodiacRank,
                        month: month,
                        day: dayNumbers,
                        hour: hour
                    };

                    const lowerGua = {
                        year: calculateLowerNumber(upperGua.year),
                        month: calculateLowerNumber(upperGua.month),
                        day: dayNumbers.map(d => calculateLowerNumber(d)),
                        hour: calculateLowerNumber(upperGua.hour)
                    };

                    // åˆ›å»ºç»“æœå¡ç‰‡
                    const resultCard = document.createElement('div');
                    resultCard.className = 'result-card';
                    resultCard.innerHTML = generateResultHTML(year, zodiacRank, upperGua, lowerGua, dateStr);
                    resultGrid.appendChild(resultCard);
                } else {
                    // åˆ›å»ºé”™è¯¯æç¤ºå¡ç‰‡
                    const errorCard = document.createElement('div');
                    errorCard.className = 'result-card error';
                    errorCard.innerHTML = `
                        <h3 style="color: #f44336;">âŒ è§£æé”™è¯¯</h3>
                        <p>æ— æ³•è§£ææ—¥æœŸï¼š${dateStr}</p>
                        <p style="font-size: 0.9em; color: #666;">${parsedDate.error}</p>
                        <div style="margin-top: 10px;">
                            <p style="font-weight: bold;">æ­£ç¡®æ ¼å¼ç¤ºä¾‹ï¼š</p>
                            <div class="format-example">1999.1.13 è¾°æ—¶</div>
                            <div class="format-example">2000å¹´3æœˆ15æ—¥ä¸‹åˆ2ç‚¹</div>
                            <div class="format-example">1988å¹´è…ŠæœˆäºŒåä¸‰æ™šä¸Š11ç‚¹</div>
                        </div>
                    `;
                    resultGrid.appendChild(errorCard);
                    hasError = true;
                }
            });

            document.getElementById('resultSection').style.display = 'block';
            document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth' });
        }

        function generateResultHTML(year, zodiacRank, upperGua, lowerGua, originalDate) {
            const zodiac = zodiacData[zodiacRank];
            const upperAnalyses = analyzeGua(upperGua, 'ä¸Šå¦');
            const lowerAnalyses = analyzeGua(lowerGua, 'ä¸‹å¦');

            // æ”¶é›†æ‰€æœ‰éœ€è¦é«˜äº®çš„æ•°å­—ç»„åˆ
            const highlightCombinations = new Set();
            const allAnalyses = [upperAnalyses, lowerAnalyses].filter(Boolean);
            
            allAnalyses.forEach(analysis => {
                const matches = analysis.match(/\d+-\d+(?:-\d+)?/g) || [];
                matches.forEach(match => highlightCombinations.add(match));
            });

            // äº”è¡Œåˆ†æ
            const allNumbers = [
                upperGua.year, upperGua.month, ...upperGua.day, upperGua.hour,
                lowerGua.year, lowerGua.month, ...lowerGua.day, lowerGua.hour
            ];
            const allElements = allNumbers.map(num => getElementForNumber(num));
            const elementAnalyses = [];
            if (!allElements.includes('åœŸ')) {
                elementAnalyses.push('äº”è¡Œç¼ºåœŸï¼Œæ²¡æœ‰è´¢åº“');
            }
            if (!allElements.includes('é‡‘')) {
                elementAnalyses.push('äº”è¡Œç¼ºé‡‘ï¼Œè´¢è¿å—é˜»');
            }
            
            return `
                <h3>ğŸ¯ ${originalDate}</h3>
                <div class="zodiac-info">
                    <span class="zodiac-emoji">${zodiac.emoji}</span>
                    <div>
                        <strong>${year}å¹´ç”Ÿäºº</strong><br>
                        <span style="color: #666;">ç”Ÿè‚–ï¼š${zodiac.name}ï¼ˆæ’åï¼š${zodiacRank}ï¼‰</span>
                    </div>
                </div>
                <!-- å…«å­—æ’ç›˜è¡¨æ ¼ -->
                ${generateBaziTableHTML(upperGua, lowerGua)}
                <!-- åˆ†æç»“æœ -->
                <div class="analysis-summary" style="padding: 15px 25px; text-align: left; line-height: 1.8;">
                    ${upperAnalyses ? `<p style="color: #c9302c;"><strong>ä¸Šå¦ï¼š ${upperAnalyses}</p>` : ''}</strong>
                    ${lowerAnalyses ? `<p style="color: #c9302c;"><strong>ä¸‹å¦ï¼š${lowerAnalyses}</p>` : ''}</strong> 
                    ${elementAnalyses.length > 0 ? `<p style="color: #c9302c;"><strong>äº”è¡Œåˆ†æï¼š</strong> ${elementAnalyses.join('ã€')}</p>` : ''}
                    ${!upperAnalyses && !lowerAnalyses && elementAnalyses.length === 0 ? '<div class="analysis-item positive" style="text-align:center;">âœ¨ å…«å­—å¹³å’Œï¼Œæ— æ˜æ˜¾å†²å…‹</div>' : ''}
                </div>
                <!-- æ—¶è¾°å¯¹ç…§è¡¨ -->
                <div class="time-reference" style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px;">
                    <h4 style="margin-bottom: 10px;">æ—¶è¾°å¯¹ç…§è¡¨</h4>
                    <table class="lookup-table shichen-table">
                        <tbody>
                            <tr>
                                <td><strong>å­æ—¶-1</strong>23:00-1:00</td>
                                <td><strong>ä¸‘æ—¶-2</strong>1:00-3:00</td>
                                <td><strong>å¯…æ—¶-3</strong>3:00-5:00</td>
                                <td><strong>å¯æ—¶-4</strong>5:00-7:00</td>
                                <td><strong>è¾°æ—¶-5</strong>7:00-9:00</td>
                                <td><strong>å·³æ—¶-6</strong>9:00-11:00</td>
                            </tr>
                            <tr>
                                <td><strong>åˆæ—¶-7</strong>11:00-13:00</td>
                                <td><strong>æœªæ—¶-8</strong>13:00-15:00</td>
                                <td><strong>ç”³æ—¶-9</strong>15:00-17:00</td>
                                <td><strong>é…‰æ—¶-10</strong>17:00-19:00</td>
                                <td><strong>æˆŒæ—¶-11</strong>19:00-21:00</td>
                                <td><strong>äº¥æ—¶-12</strong>21:00-23:00</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <!-- å‡¶æ•°å¯¹ç…§è¡¨ -->
                <div class="xiongshu-tables-container" style="margin-top: 20px;">
                    <div>
                        <table class="lookup-table">
                            <thead>
                                <tr><th colspan="2" class="xiongshu-header bajue-header">å…«ç»æ•°ç»„</th></tr>
                            </thead>
                            <tbody>
                                ${[
                                    ['1-8', '8-1'], ['1-9', '9-1'], ['6-2', '2-6'],
                                    ['3-5', '5-3'], ['3-6', '6-3'], ['4-10', '10-4'],
                                    ['11-7', '7-11'], ['7-12', '12-7']
                                ].map(row => `
                                    <tr>
                                        <td>${highlightCombinations.has(row[0]) ? `<span class="highlight-combination">${row[0]}</span>` : row[0]}</td>
                                        <td>${highlightCombinations.has(row[1]) ? `<span class="highlight-combination">${row[1]}</span>` : row[1]}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    <div>
                        <table class="lookup-table">
                            <thead>
                                <tr><th colspan="2" class="xiongshu-header liuchong-header">å…­å†²æ•°ç»„</th></tr>
                            </thead>
                            <tbody>
                                ${[
                                    ['1-7', '7-1'], ['8-2', '2-8'], ['3-9', '9-3'],
                                    ['10-4', '4-10'], ['11-5', '5-11'], ['12-6', '6-12']
                                ].map(row => `
                                    <tr>
                                        <td>${highlightCombinations.has(row[0]) ? `<span class="highlight-combination">${row[0]}</span>` : row[0]}</td>
                                        <td>${highlightCombinations.has(row[1]) ? `<span class="highlight-combination">${row[1]}</span>` : row[1]}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    <div>
                        <table class="lookup-table">
                            <thead>
                                <tr><th colspan="2" class="xiongshu-header shuangmu-header">åŒæœ¨å…‹åœŸ</th></tr>
                            </thead>
                            <tbody>
                                ${[
                                    ['3-8-4', '3-8-5'], ['3-9-4', '3-9-5'], ['4-3-4', '4-3-5'],
                                    ['4-8-5', '4-9-5'], ['4-8-4', '4-9-4'], ['5-8-5', '5-9-5'],
                                    ['5-3-5', '']
                                ].map(row => `
                                    <tr>
                                        <td>${highlightCombinations.has(row[0]) ? `<span class="highlight-combination">${row[0]}</span>` : row[0]}</td>
                                        <td>${row[1] && highlightCombinations.has(row[1]) ? `<span class="highlight-combination">${row[1]}</span>` : row[1]}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    <div>
                        <table class="lookup-table">
                            <thead>
                                <tr><th class="xiongshu-header zhongliu-header">è‚¿ç˜¤æ•°å­—</th></tr>
                            </thead>
                            <tbody>
                                ${[
                                    ['3-3'], ['3-9'], ['6-3'],
                                    ['7-3'], ['9-3'], ['9-9']
                                ].map(row => `
                                    <tr>
                                        <td>${highlightCombinations.has(row[0]) ? `<span class="highlight-combination">${row[0]}</span>` : row[0]}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function generateBaziTableHTML(upperGua, lowerGua) {
            // ç”Ÿæˆå…«å­—æ’ç›˜è¡¨æ ¼çš„HTML
            return `
                <table class="bazi-table">
                    <thead>
                        <tr>
                            <th>å¦è±¡</th>
                            <th>å…«å­—æ’ç›˜</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>ä¸Šå¦</td>
                            <td>
                                <div class="pillar-container">
                                    ${generatePillarHTML(upperGua.year, 'å¹´æŸ±')}
                                    <span class="horizontal-line"></span>
                                    ${generatePillarHTML(upperGua.month, 'æœˆæŸ±')}
                                    <span class="horizontal-line"></span>
                                    ${upperGua.day.map(d => generatePillarHTML(d, 'æ—¥æŸ±')).join('<span class="horizontal-line"></span>')}
                                    <span class="horizontal-line"></span>
                                    ${generatePillarHTML(upperGua.hour, 'æ—¶æŸ±')}
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>ä¸‹å¦</td>
                            <td>
                                <div class="pillar-container">
                                    ${generatePillarHTML(lowerGua.year, 'å¹´æŸ±')}
                                    <span class="horizontal-line"></span>
                                    ${generatePillarHTML(lowerGua.month, 'æœˆæŸ±')}
                                    <span class="horizontal-line"></span>
                                    ${lowerGua.day.map(d => generatePillarHTML(d, 'æ—¥æŸ±')).join('<span class="horizontal-line"></span>')}
                                    <span class="horizontal-line"></span>
                                    ${generatePillarHTML(lowerGua.hour, 'æ—¶æŸ±')}
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            `;
        }

        function generatePillarHTML(number, label) {
            const element = getElementForNumber(number);
            const elementColor = getElementClass(element);
            return `
                <div class="pillar-group">
                    <span class="pillar-label">${label}</span>
                    <div class="pillar-item">
                        <span>${number}</span>
                        <span class="element-tag" style="background-color: ${elementColor}">${element}</span>
                    </div>
                </div>
            `;
        }

        function analyzeGua(gua, type) {
            let analyses = [];
            
            // çˆ¶æ¯å®«åˆ†æ
            const parentPalace = analyzeRelation(gua.year, gua.month, 'çˆ¶æ¯å®«', type);
            analyses = analyses.concat(parentPalace);
            
            // å¤«å¦»å®«åˆ†æ
            gua.day.forEach(dayNum => {
                const marriagePalace = analyzeRelation(gua.month, dayNum, 'å¤«å¦»å®«', type);
                analyses = analyses.concat(marriagePalace);
            });
            
            // å­å¥³å®«åˆ†æ
            gua.day.forEach(dayNum => {
                const childPalace = analyzeRelation(dayNum, gua.hour, 'å­å¥³å®«', type);
                analyses = analyses.concat(childPalace);
            });
            
            return analyses.join('ã€');
        }

        function analyzeRelation(num1, num2, palace, guaType) {
            const issues = [];
            
            // æ£€æŸ¥å…«ç»
            if (baJue.some(pair => (pair[0] === num1 && pair[1] === num2) || (pair[0] === num2 && pair[1] === num1))) {
                issues.push(`${num1}-${num2}${palace}å…«ç»`);
            }
            
            // æ£€æŸ¥å…­å†²
            if (liuChong.some(pair => (pair[0] === num1 && pair[1] === num2) || (pair[0] === num2 && pair[1] === num1))) {
                issues.push(`${num1}-${num2}${palace}å…­å†²`);
            }
            
            // æ£€æŸ¥è‚¿ç˜¤æ•°å­—
            if (zhongLiu.some(pair => (pair[0] === num1 && pair[1] === num2) || (pair[0] === num2 && pair[1] === num1))) {
                issues.push(`${num1}-${num2}${palace}è‚¿ç˜¤æ•°`);
            }
            
            // äº”è¡Œç›¸å…‹åˆ†æ
            const element1 = getElementForNumber(num1);
            const element2 = getElementForNumber(num2);
            const å…‹å…³ç³» = analyzeElementRelation(element1, element2);
            if (å…‹å…³ç³») {
                issues.push(`${num1}-${num2}${palace}${å…‹å…³ç³»}`);
            }
            
            return issues;
        }

        function analyzeElementRelation(elem1, elem2) {
            const keRelations = {
                'æœ¨': 'åœŸ', 'ç«': 'é‡‘', 'åœŸ': 'æ°´', 'é‡‘': 'æœ¨', 'æ°´': 'ç«'
            };
            
            if (keRelations[elem1] === elem2) {
                return `${elem1}å…‹${elem2}`;
            }
            if (keRelations[elem2] === elem1) {
                return `${elem2}å…‹${elem1}`;
            }
            return null;
        }

        function displayResults(year, zodiacIndex, upperGua, lowerGua) {
            const day = parseInt(document.getElementById('day').value);
            const zodiac = zodiacData[zodiacIndex];
            
            // åˆ†æä¸Šä¸‹å¦
            const upperAnalyses = analyzeGua(upperGua, 'ä¸Šå¦');
            const lowerAnalyses = analyzeGua(lowerGua, 'ä¸‹å¦');

            // æ”¶é›†æ‰€æœ‰éœ€è¦é«˜äº®çš„æ•°å­—ç»„åˆ
            const highlightCombinations = new Set();
            const allAnalyses = [upperAnalyses, lowerAnalyses].filter(Boolean);
            
            allAnalyses.forEach(analysis => {
                const matches = analysis.match(/\d+-\d+(?:-\d+)?/g) || [];
                matches.forEach(match => highlightCombinations.add(match));
            });

            // äº”è¡Œåˆ†æ
            const allNumbers = [
                upperGua.year, upperGua.month, ...upperGua.day, upperGua.hour,
                lowerGua.year, lowerGua.month, ...lowerGua.day, lowerGua.hour
            ];
            const allElements = allNumbers.map(num => getElementForNumber(num));
            const elementAnalyses = [];
            if (!allElements.includes('åœŸ')) {
                elementAnalyses.push('äº”è¡Œç¼ºåœŸï¼Œæ²¡æœ‰è´¢åº“');
            }
            if (!allElements.includes('é‡‘')) {
                elementAnalyses.push('äº”è¡Œç¼ºé‡‘ï¼Œè´¢è¿å—é˜»');
            }

            // æ ¹æ®æ—¥æœŸç”Ÿæˆä¸åŒçš„è¡¨å¤´å’Œå†…å®¹
            let tableHeadersHTML = '';
            let upperGuaRowHTML = '';
            let lowerGuaRowHTML = '';

            // åˆ›å»ºæŸ±å­æ˜¾ç¤º
            function createPillarDisplay(number, element, label) {
                const elementColor = getElementClass(element);
                return `
                    <div class="pillar-group">
                        <span class="pillar-label">${label}</span>
                        <div class="pillar-item">
                            <span>${number}</span>
                            <span class="element-tag" style="background-color: ${elementColor}">${element}</span>
                        </div>
                    </div>
                `;
            }

            if (day <= 12) {
                tableHeadersHTML = `
                    <th>å¦è±¡</th>
                    <th>å…«å­—æ’ç›˜</th>
                `;
                
                // åˆ›å»ºä¸Šå¦è¡Œ
                const upperYearElement = getElementForNumber(upperGua.year);
                const upperMonthElement = getElementForNumber(upperGua.month);
                const upperDayElement = getElementForNumber(upperGua.day[0]);
                const upperHourElement = getElementForNumber(upperGua.hour);

                upperGuaRowHTML = `
                    <td>ä¸Šå¦</td>
                    <td>
                        <div class="pillar-container">
                            ${createPillarDisplay(upperGua.year, upperYearElement, 'å¹´æŸ±')}
                            <span class="horizontal-line"></span>
                            ${createPillarDisplay(upperGua.month, upperMonthElement, 'æœˆæŸ±')}
                            <span class="horizontal-line"></span>
                            ${createPillarDisplay(upperGua.day[0], upperDayElement, 'æ—¥æŸ±')}
                            <span class="horizontal-line"></span>
                            ${createPillarDisplay(upperGua.hour, upperHourElement, 'æ—¶æŸ±')}
                        </div>
                    </td>`;

                // åˆ›å»ºä¸‹å¦è¡Œ
                const lowerYearElement = getElementForNumber(lowerGua.year);
                const lowerMonthElement = getElementForNumber(lowerGua.month);
                const lowerDayElement = getElementForNumber(lowerGua.day[0]);
                const lowerHourElement = getElementForNumber(lowerGua.hour);

                lowerGuaRowHTML = `
                    <td>ä¸‹å¦</td>
                    <td>
                        <div class="pillar-container">
                            ${createPillarDisplay(lowerGua.year, lowerYearElement, 'å¹´æŸ±')}
                            <span class="horizontal-line"></span>
                            ${createPillarDisplay(lowerGua.month, lowerMonthElement, 'æœˆæŸ±')}
                            <span class="horizontal-line"></span>
                            ${createPillarDisplay(lowerGua.day[0], lowerDayElement, 'æ—¥æŸ±')}
                            <span class="horizontal-line"></span>
                            ${createPillarDisplay(lowerGua.hour, lowerHourElement, 'æ—¶æŸ±')}
                        </div>
                    </td>`;
            } else {
                tableHeadersHTML = `
                    <th>å¦è±¡</th>
                    <th>å…«å­—æ’ç›˜</th>
                `;
                
                let upperDayPillars = upperGua.day.map(d => createPillarDisplay(d, getElementForNumber(d), 'æ—¥æŸ±')).join('<div class="horizontal-line"></div>');
                upperGuaRowHTML = `
                    <td>ä¸Šå¦</td>
                    <td>
                        <div class="pillar-container">
                            ${createPillarDisplay(upperGua.year, getElementForNumber(upperGua.year), 'å¹´æŸ±')}
                            <div class="horizontal-line"></div>
                            ${createPillarDisplay(upperGua.month, getElementForNumber(upperGua.month), 'æœˆæŸ±')}
                            <div class="horizontal-line"></div>
                            ${upperDayPillars}
                            <div class="horizontal-line"></div>
                            ${createPillarDisplay(upperGua.hour, getElementForNumber(upperGua.hour), 'æ—¶æŸ±')}
                        </div>
                    </td>`;
                
                let lowerDayPillars = lowerGua.day.map(d => createPillarDisplay(d, getElementForNumber(d), 'æ—¥æŸ±')).join('<div class="horizontal-line"></div>');
                lowerGuaRowHTML = `
                    <td>ä¸‹å¦</td>
                    <td>
                        <div class="pillar-container">
                            ${createPillarDisplay(lowerGua.year, getElementForNumber(lowerGua.year), 'å¹´æŸ±')}
                            <div class="horizontal-line"></div>
                            ${createPillarDisplay(lowerGua.month, getElementForNumber(lowerGua.month), 'æœˆæŸ±')}
                            <div class="horizontal-line"></div>
                            ${lowerDayPillars}
                            <div class="horizontal-line"></div>
                            ${createPillarDisplay(lowerGua.hour, getElementForNumber(lowerGua.hour), 'æ—¶æŸ±')}
                        </div>
                    </td>`;
            }
            
            const resultHTML = `
                <div class="result-card">
                    <h3>ğŸ¯ ${originalDate}</h3>
                    <div class="zodiac-info">
                        <span class="zodiac-emoji">${zodiac.emoji}</span>
                        <div>
                            <strong>${year}å¹´ç”Ÿäºº</strong><br>
                            <span style="color: #666;">ç”Ÿè‚–ï¼š${zodiac.name}ï¼ˆæ’åï¼š${zodiacIndex}ï¼‰</span>
                        </div>
                    </div>
                </div>

                <div class="result-card">
                    <h3>ğŸ“Š å…«å­—æ’ç›˜</h3>
                    <table class="bazi-table">
                        <thead>
                            <tr>
                                ${tableHeadersHTML}
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                ${upperGuaRowHTML}
                            </tr>
                            <tr>
                                ${lowerGuaRowHTML}
                            </tr>
                        </tbody>
                    </table>
                     <div class="analysis-summary" style="padding: 15px 25px; text-align: left; line-height: 1.8;">
                        ${upperAnalyses ? `<p style="color: #c9302c;"><strong>ä¸Šå¦ï¼š</strong> ${upperAnalyses}</p>` : ''}
                        ${lowerAnalyses ? `<p style="color: #c9302c;"><strong>ä¸‹å¦ï¼š</strong> ${lowerAnalyses}</p>` : ''}
                        ${elementAnalyses.length > 0 ? `<p style="color: #c9302c;"><strong>äº”è¡Œåˆ†æï¼š</strong> ${elementAnalyses.join('ã€')}</p>` : ''}
                        ${!upperAnalyses && !lowerAnalyses && elementAnalyses.length === 0 ? '<div class="analysis-item positive" style="text-align:center;">âœ¨ å…«å­—å¹³å’Œï¼Œæ— æ˜æ˜¾å†²å…‹</div>' : ''}
                </div>
                    <div class="time-reference" style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px;">
                        <div style="display: flex; gap: 5px;">
                            <table class="lookup-table" style="flex: 1;">
                                <thead>
                                    <tr>
                                        <th colspan="2" class="xiongshu-header bajue-header">å…«ç»æ•°ç»„</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${[
                                        ['1-8', '8-1'], ['1-9', '9-1'], ['6-2', '2-6'],
                                        ['3-5', '5-3'], ['3-6', '6-3'], ['4-10', '10-4'],
                                        ['11-7', '7-11'], ['7-12', '12-7']
                                    ].map(row => `
                                        <tr>
                                            <td>${highlightCombinations.has(row[0]) ? `<span class="highlight-combination">${row[0]}</span>` : row[0]}</td>
                                            <td>${highlightCombinations.has(row[1]) ? `<span class="highlight-combination">${row[1]}</span>` : row[1]}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                            <table class="lookup-table" style="flex: 1;">
                                <thead>
                                    <tr>
                                        <th colspan="2" class="xiongshu-header liuchong-header">å…­å†²æ•°ç»„</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${[
                                        ['1-7', '7-1'], ['8-2', '2-8'], ['3-9', '9-3'],
                                        ['10-4', '4-10'], ['11-5', '5-11'], ['12-6', '6-12']
                                    ].map(row => `
                                        <tr>
                                            <td>${highlightCombinations.has(row[0]) ? `<span class="highlight-combination">${row[0]}</span>` : row[0]}</td>
                                            <td>${highlightCombinations.has(row[1]) ? `<span class="highlight-combination">${row[1]}</span>` : row[1]}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                            <table class="lookup-table" style="flex: 1;">
                                <thead>
                                    <tr>
                                        <th colspan="2" class="xiongshu-header shuangmu-header">åŒæœ¨å…‹åœŸ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${[
                                        ['3-8-4', '3-8-5'], ['3-9-4', '3-9-5'], ['4-3-4', '4-3-5'],
                                        ['4-8-5', '4-9-5'], ['4-8-4', '4-9-4'], ['5-8-5', '5-9-5'],
                                        ['5-3-5', '']
                                    ].map(row => `
                                        <tr>
                                            <td>${highlightCombinations.has(row[0]) ? `<span class="highlight-combination">${row[0]}</span>` : row[0]}</td>
                                            <td>${row[1] && highlightCombinations.has(row[1]) ? `<span class="highlight-combination">${row[1]}</span>` : row[1]}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;

            // å°†ç”Ÿæˆçš„HTMLå­—ç¬¦ä¸²è®¾ç½®ä¸ºç»“æœå¡ç‰‡çš„innerHTML
            const resultCard = document.createElement('div');
            resultCard.className = 'result-card';
            resultCard.innerHTML = resultHTML;
            resultGrid.appendChild(resultCard);
        }
    </script>
    <script src="auth.js"></script>
</body>
</html>